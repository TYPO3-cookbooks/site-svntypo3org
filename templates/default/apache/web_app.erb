<VirtualHost *:443>
	ServerName <%= @params[:server_name] %>

	DocumentRoot /var/www/vhosts/<%= @params[:server_name] %>/www/
	DirectoryIndex index.htm index.html index.php

	<Directory /var/www/vhosts/<%= @params[:server_name] %>/www/>
		Options +ExecCGI -Indexes
		Order allow,deny
		Allow from all
		AllowOverride All
	</Directory>

	ErrorLog /var/www/vhosts/<%= @params[:server_name] %>/log/error-ssl.log
	CustomLog /var/www/vhosts/<%= @params[:server_name] %>/log/access-ssl.log combined

	SSLEngine on
	SSLCertificateFile <%= node['ssl_certificates']['path'] + "/" + node['site-svntypo3org']['ssl_certificate'] + ".crt" %>
	SSLCertificateChainFile <%= node['ssl_certificates']['path'] + "/" + node['site-svntypo3org']['ssl_certificate'] + ".crt" %>
	SSLCertificateKeyFile <%= node['ssl_certificates']['path'] + "/" + node['site-svntypo3org']['ssl_certificate'] + ".key" %>

	AddExternalAuth forge-auth /opt/svn-helpers/apache-svn-authenticator.php
	SetExternalAuthMethod forge-auth pipe


	<Location /TYPO3v4/Extensions>
		DAV svn
		SVNPath /var/lib/svn/typo3v4/extensions

		AuthzSVNAccessFile /var/lib/svn/typo3v4/extensions/conf/authz

		# try anonymous access first, resort to real authentication if necessary
		AuthzSVNNoAuthWhenAnonymousAllowed On
		Satisfy Any
		Require valid-user

		AuthType Basic
		AuthName "TYPO3 SVN Access"
		AuthBasicProvider external
		AuthExternal forge-auth

	</Location>
</VirtualHost>

<VirtualHost *:80>
	ServerName <%= @params[:server_name] %>

	RewriteEngine on
	RewriteRule /.* https://<%= @params[:server_name] %>/ [R=302,L]
</VirtualHost>
